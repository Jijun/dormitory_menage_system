<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>修改密码</title>
		<script src="../js/jquery-latest.js"></script>
		<script type="text/javascript" src="../js/layer_mobile/layer.js"></script>
	</head>

	<body>
		<a>绑定邮箱：</a><input type="text" style="text-align: left;" id="useremail_text" value="" placeholder="用户邮箱" disabled="true" /><input id="email_button" type="button" onclick="send_code()" value="获取验证码"><br/>
		<a>验证码：</a><input type="text" style="text-align: left;" id="verifycode_text" value="" placeholder="验证码" /><br/>
		<a>旧密码：</a><input type="password" style="text-align: center;" name="old_password" id="old_password" value="" placeholder="旧密码" /><br/>
		<a>新密码：</a><input type="password" style="text-align: center;" name="new_password" id="new_password" value="" placeholder="新密码" /><br/>
		<a>重复输入新密码：</a><input type="password" style="text-align: center;" name="new_password2" id="new_password2" value="" placeholder="重复输入新密码" /><br/>
		<input id="change_password" type="button" onclick="change_password()" value="修改密码"><br/>
		<script type="text/javascript">
			//初始化网页加载用户信息
			token = sessionStorage.getItem("token");
			if(token == null) {
				window.location.href = '../index.html';
			} else {
				$.ajax({
					url: "http://127.0.0.1:8000/userinfo/" + sessionStorage.getItem("user_id") + "/",
					type: "get",
					headers: {
						"Authorization": sessionStorage.getItem("token")
					},
					success: function(data) {
						document.getElementById("useremail_text").value = data.user.email;
					},
					error: function(jqXHR) {
						alert("请先绑定邮箱");
					}
				})
			}

			//点击邮箱"获取验证码"按钮
			function send_code() {
				var email = document.getElementById("useremail_text").value;
				$.ajax({
					url: "http://127.0.0.1:8000/code/",
					type: "post",
					dataType: "json",
					headers: {
						"Authorization": sessionStorage.getItem("token")
					},
					data: {
						"email": email
					},
					success: function(data) {
						alert(data.msg);
						document.getElementById("email_button").disabled = true;
						var num = 60;
						var timer = setInterval(function() {
							num--;
							document.getElementById("email_button").value = "发送成功(" + num + "s)"
							if(num == 0) {
								clearInterval(timer); //到时间取消执行
								document.getElementById("email_button").disabled = false;
								document.getElementById("email_button").value = "重新发送";
							}
						}, 1000); //每1000毫秒执行一次
					},
					error: function(jqXHR) {
						var json_responseText = JSON.parse(jqXHR.responseText);
						alert(json_responseText.email[0]);
					}
				})
			}

			//点击"修改"密码按钮
			function change_password() {
				var code = document.getElementById("verifycode_text").value;
				var old_password = document.getElementById("old_password").value;
				var new_password = document.getElementById("new_password").value;

				$.ajax({
					url: "http://127.0.0.1:8000/changepassword/" + sessionStorage.getItem("user_id") + "/",
					type: "put",
					dataType: "json",
					headers: {
						"Authorization": sessionStorage.getItem("token")
					},
					data: {
						"code": code,
						"old_password": old_password,
						"new_password": new_password,
					},
					success: function(data) {
						alert(data.username + "密码修改成功");
						window.location.href="information.html"
					},
					error: function(jqXHR) {
						var json_responseText = JSON.parse(jqXHR.responseText);
						alert(json_responseText.code[0]);
					}
				})
			}
		</script>

	</body>

</html>